---
openapi: 3.0.1
info:
  title: Movie Store Subscription API
  version: v1
  description: API for managing Apple In-App Purchase subscriptions for a video streaming
    service
paths:
  "/api/subscriptions":
    post:
      summary: Create a subscription (provisional start)
      tags:
      - Subscriptions
      description: 'Called by the client app after Apple In-App Purchase completes.
        Creates a subscription in ''pending'' state. Idempotent: if transaction_id
        already exists, returns the existing record.'
      parameters: []
      responses:
        '201':
          description: Subscription created (pending)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  user_id:
                    type: string
                  transaction_id:
                    type: string
                  product_id:
                    type: string
                  status:
                    type: string
                    enum:
                    - pending
                    - active
                    - cancelled
                  viewable:
                    type: boolean
                  purchase_date:
                    type: string
                    nullable: true
                    format: date-time
                  expires_date:
                    type: string
                    nullable: true
                    format: date-time
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        '200':
          description: Subscription already exists (idempotent)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  user_id:
                    type: string
                  transaction_id:
                    type: string
                  product_id:
                    type: string
                  status:
                    type: string
                  viewable:
                    type: boolean
                  purchase_date:
                    type: string
                    nullable: true
                    format: date-time
                  expires_date:
                    type: string
                    nullable: true
                    format: date-time
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                subscription:
                  type: object
                  required:
                  - user_id
                  - transaction_id
                  - product_id
                  properties:
                    user_id:
                      type: string
                      example: user_123
                      description: User identifier
                    transaction_id:
                      type: string
                      example: txn_abc
                      description: Apple transaction ID (unique per subscription)
                    product_id:
                      type: string
                      example: com.samansa.subscription.monthly
                      description: Subscription plan ID
              required:
              - subscription
  "/api/subscriptions/{user_id}":
    get:
      summary: Get subscriptions for a user
      tags:
      - Subscriptions
      description: Returns all subscriptions for a given user, including their viewing
        eligibility.
      parameters:
      - name: user_id
        in: path
        description: User ID
        example: user_123
        required: true
        schema:
          type: string
      responses:
        '200':
          description: User subscriptions retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                  subscriptions:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        user_id:
                          type: string
                        transaction_id:
                          type: string
                        product_id:
                          type: string
                        status:
                          type: string
                          enum:
                          - pending
                          - active
                          - cancelled
                        viewable:
                          type: boolean
                        purchase_date:
                          type: string
                          nullable: true
                          format: date-time
                        expires_date:
                          type: string
                          nullable: true
                          format: date-time
                        created_at:
                          type: string
                          format: date-time
                        updated_at:
                          type: string
                          format: date-time
  "/api/webhooks/apple":
    post:
      summary: Receive Apple Server Notification
      tags:
      - Webhooks
      description: 'Receives Apple Server-to-Server notifications for subscription
        lifecycle events (PURCHASE, RENEW, CANCEL). Idempotent: duplicate notification_uuid
        is safely ignored.'
      parameters: []
      responses:
        '200':
          description: Duplicate notification ignored (idempotent)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: already_processed
        '404':
          description: Subscription not found for transaction_id
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                webhook:
                  type: object
                  required:
                  - notification_uuid
                  - type
                  - transaction_id
                  - product_id
                  - purchase_date
                  - expires_date
                  properties:
                    notification_uuid:
                      type: string
                      example: notif_001
                      description: Unique notification identifier
                    type:
                      type: string
                      enum:
                      - PURCHASE
                      - RENEW
                      - CANCEL
                      description: Event type
                    transaction_id:
                      type: string
                      example: txn_abc
                      description: Apple transaction ID
                    product_id:
                      type: string
                      example: com.samansa.subscription.monthly
                      description: Subscription plan ID
                    amount:
                      type: string
                      example: '3.9'
                      description: Charge amount
                    currency:
                      type: string
                      example: USD
                      description: Currency code
                    purchase_date:
                      type: string
                      format: date-time
                      example: '2025-10-01T12:00:00Z'
                      description: Period start date
                    expires_date:
                      type: string
                      format: date-time
                      example: '2025-11-01T12:00:00Z'
                      description: Period end / next renewal date
              required:
              - webhook
servers:
- url: http://localhost:3000
  description: Development server
